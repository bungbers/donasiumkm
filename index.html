<script>
  const PROJECTS_KEY = 'umkm_projects_v2';
  const DONORS_KEY = 'umkm_donors_v2';

  const DEFAULT_PROJECTS = [
    {
      id:'p1',
      title:'Pelatihan Jahit Desa Cempaka',
      category:'Fashion',
      image:'https://source.unsplash.com/600x400/?sewing',
      location:'Kabupaten Banyumas',
      desc:'Pelatihan menjahit dan pemberian mesin jahit untuk ibu-ibu rumah tangga agar dapat memulai usaha.',
      contact:'08123456789',
      target:15000000,
      raised:4200000,
      endDate:'2025-12-31'
    }
  ];

  let PROJECTS = load(PROJECTS_KEY) || DEFAULT_PROJECTS;
  let DONORS = load(DONORS_KEY) || [];

  const projectsEl = document.getElementById('projects');
  const summaryEl = document.getElementById('summary');

  function save(key, data){localStorage.setItem(key, JSON.stringify(data));}
  function load(key){try{return JSON.parse(localStorage.getItem(key));}catch(e){return null}}
  function uid(){return 'id'+Math.random().toString(36).slice(2,9)}

  function formatRp(n){return (n||0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');}
  function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c]));}

  // Render daftar project
  function renderProjects(filter=''){
    projectsEl.innerHTML='';
    const q=filter.toLowerCase();
    const list = PROJECTS.filter(p=>!q || (p.title+p.location+p.desc).toLowerCase().includes(q));
    if(list.length===0){
      projectsEl.innerHTML='<div class="card" style="padding:16px">Tidak ada project</div>';
      return;
    }
    for(const p of list){
      const percent = Math.min(100, Math.round((p.raised||0)/(p.target||1)*100));
      const expired = p.endDate && new Date(p.endDate)<new Date();
      const el = document.createElement('div');
      el.className='card';
      el.innerHTML=`
        <img src="${escapeHtml(p.image||'https://via.placeholder.com/600x400')}" alt="${escapeHtml(p.title)}">
        <div class="card-body">
          <div class="badge">${escapeHtml(p.category||'Lainnya')}</div>
          <h3>${escapeHtml(p.title)}</h3>
          <div class="muted">${escapeHtml(p.location)}</div>
          <p class="muted" style="margin:6px 0">${escapeHtml(p.desc||'')}</p>
          <div class="progress"><div class="progress-bar" style="width:${percent}%"></div></div>
          <div class="muted">Rp ${formatRp(p.raised)} dari Rp ${formatRp(p.target)} (${percent}%)</div>
          <div class="muted">Kontak: ${escapeHtml(p.contact||'-')}</div>
          <div class="muted">Berakhir: ${p.endDate || '-'}</div>
          ${expired ? '<div style="color:red;font-weight:bold;margin-top:4px">Kampanye Berakhir</div>':''}
          <div class="actions">
            <button class="btn btn-primary" data-action="donate" data-id="${p.id}" ${expired?'disabled':''}>Donasi</button>
            <button class="btn btn-ghost" data-action="edit" data-id="${p.id}">Edit</button>
          </div>
          <button class="btn btn-ghost" style="margin-top:6px" onclick="shareWhatsApp('${escapeHtml(p.title)}')">Share WA</button>
        </div>`;
      projectsEl.appendChild(el);
    }
  }

  function renderSummary(){
    const totalRaised = PROJECTS.reduce((s,p)=>s+(p.raised||0),0);
    const totalTarget = PROJECTS.reduce((s,p)=>s+(p.target||0),0);
    summaryEl.innerHTML = `Total Terkumpul: Rp ${formatRp(totalRaised)} • Total Target: Rp ${formatRp(totalTarget)} • Donatur: ${DONORS.length}`;
  }

  // Event listener tombol Donasi & Edit
  projectsEl.addEventListener('click',e=>{
    const btn=e.target.closest('button');if(!btn)return;
    const id=btn.dataset.id;
    if(btn.dataset.action==='donate') openDonateModal(id);
    if(btn.dataset.action==='edit') openProjectModal(id);
  });

  document.getElementById('search').addEventListener('input',e=>renderProjects(e.target.value));

  // Donate Modal
  const donateModal=document.getElementById('donateModal');
  function openDonateModal(id){
    const p=PROJECTS.find(x=>x.id===id);
    document.getElementById('modalTitle').textContent='Donasi ke '+p.title;
    document.getElementById('modalProjectDesc').textContent=p.location;
    donateModal.classList.add('open');
    donateModal.dataset.projectId=id;
  }
  function closeDonateModal(){donateModal.classList.remove('open');}
  document.getElementById('cancelDonate').onclick=closeDonateModal;
  donateModal.addEventListener('click',e=>{if(e.target===donateModal)closeDonateModal();});

  document.getElementById('donateForm').addEventListener('submit',e=>{
    e.preventDefault();
    const name=document.getElementById('donorName').value.trim()||'Anonim';
    const amount=Number(document.getElementById('donationAmount').value)||0;
    const pid=donateModal.dataset.projectId;
    if(amount<1000){alert('Minimal Rp 1.000');return}
    const donor={id:uid(),name,amount,projectId:pid,date:new Date().toISOString()};
    DONORS.push(donor);save(DONORS_KEY,DONORS);
    const p=PROJECTS.find(x=>x.id===pid);if(p){p.raised=(p.raised||0)+amount;save(PROJECTS_KEY,PROJECTS);}
    renderProjects();renderSummary();closeDonateModal();alert('Terima kasih! Donasi Anda tercatat (demo).');
  });

  // Project Modal
  const projectModal=document.getElementById('projectModal');
  document.getElementById('addProjectBtn').onclick=()=>openProjectModal();

  function openProjectModal(id){
    projectModal.classList.add('open');
    if(id){
      const p=PROJECTS.find(x=>x.id===id);
      document.getElementById('projTitle').value=p.title;
      document.getElementById('projCategory').value=p.category;
      document.getElementById('projImage').value=p.image;
      document.getElementById('projLoc').value=p.location;
      document.getElementById('projDesc').value=p.desc;
      document.getElementById('projContact').value=p.contact;
      document.getElementById('projTarget').value=p.target;
      document.getElementById('projEndDate').value=p.endDate;
      projectModal.dataset.editId=id;
    } else {
      projectModal.dataset.editId='';
      projectModal.querySelector('form').reset();
    }
  }
  function closeProjectModal(){projectModal.classList.remove('open');}
  document.getElementById('cancelProject').onclick=closeProjectModal;
  projectModal.addEventListener('click',e=>{if(e.target===projectModal)closeProjectModal();});

  document.getElementById('projectForm').addEventListener('submit',e=>{
    e.preventDefault();
    const id=projectModal.dataset.editId||uid();
    const data={
      id,
      title:document.getElementById('projTitle').value.trim(),
      category:document.getElementById('projCategory').value,
      image:document.getElementById('projImage').value.trim(),
      location:document.getElementById('projLoc').value.trim(),
      desc:document.getElementById('projDesc').value.trim(),
      contact:document.getElementById('projContact').value.trim(),
      target:Number(document.getElementById('projTarget').value)||0,
      raised:projectModal.dataset.editId ? PROJECTS.find(x=>x.id===id).raised : 0,
      endDate:document.getElementById('projEndDate').value
    };
    if(projectModal.dataset.editId){
      const idx=PROJECTS.findIndex(x=>x.id===id);
      PROJECTS[idx]=data;
    } else {
      PROJECTS.push(data);
    }
    save(PROJECTS_KEY,PROJECTS);
    renderProjects();renderSummary();closeProjectModal();
  });

  // Export Donors CSV
  document.getElementById('exportBtn').addEventListener('click',()=>{
    if(DONORS.length===0){alert('Belum ada data donatur');return}
    const rows=[['id','nama','jumlah','projectId','tanggal']];
    for(const d of DONORS){rows.push([d.id,d.name,d.amount,d.projectId,d.date]);}
    const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'donatur.csv';
    a.click();
    URL.revokeObjectURL(url);
  });

  // Tombol Share WhatsApp
  function shareWhatsApp(title){
    const text = encodeURIComponent(`Yuk dukung campaign UMKM "${title}" melalui web donasi ini!`);
    window.open(`https://wa.me/?text=${text}`, '_blank');
  }

  // Inisialisasi awal
  renderProjects();
  renderSummary();
</script>
