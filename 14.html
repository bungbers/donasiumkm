<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UMKM Donasi Web App</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 0; }
    .container { max-width: 900px; margin: auto; padding: 20px; }
    h1 { text-align: center; }
    .card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
    input, textarea, button { width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; }
    button { cursor: pointer; background: #007bff; color: #fff; border: none; }
    button:hover { background: #0056b3; }
    .flex { display: flex; gap: 10px; }
    .project-img { width: 120px; height: 80px; object-fit: cover; border-radius: 5px; background: #f0f0f0; }
    .status { font-size: 14px; color: #555; margin-top: 10px; }
  </style>
</head>
<body>
<div class="container">
  <h1>UMKM Donasi</h1>
  <div class="card">
    <h3>Pengaturan GitHub (Opsional)</h3>
    <input type="text" id="owner" placeholder="Owner (username/org)">
    <input type="text" id="repo" placeholder="Repo name">
    <input type="text" id="branch" placeholder="Branch (misal: main)" value="main">
    <input type="password" id="token" placeholder="Personal Access Token">
    <small>Token hanya dipakai di browser ini. Untuk keamanan publik, gunakan backend server.</small>
  </div>

  <div class="card">
    <h3 id="form-title">Tambah Project Donasi</h3>
    <input type="text" id="title" placeholder="Judul project" required>
    <input type="number" id="target" placeholder="Target donasi" required>
    <textarea id="description" placeholder="Deskripsi" required></textarea>
    <input type="number" id="collected" placeholder="Terkumpul" value="0">
    <input type="file" id="imageFile" accept="image/*">
    <div class="flex">
      <button onclick="saveProject()">Simpan</button>
      <button onclick="resetForm()">Batal</button>
    </div>
  </div>

  <div id="projects"></div>
  <div class="status" id="statusMsg">Status: Ready</div>
</div>

<script>
  let projects = [];
  let editId = null;
  const PROJECTS_PATH = 'data/projects.json';

  document.addEventListener('DOMContentLoaded', () => {
    const local = localStorage.getItem('umkm_projects');
    if (local) {
      projects = JSON.parse(local);
      renderProjects();
    }
  });

  function toBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result.split(',')[1]);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  async function githubPutFile({ owner, repo, path, contentBase64, message, branch, token }) {
    const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
    let existingSha = null;
    const getResp = await fetch(`${url}?ref=${branch}`, {
      headers: { Authorization: `token ${token}` }
    });
    if (getResp.ok) {
      const data = await getResp.json();
      if (data.sha) existingSha = data.sha;
    }

    const body = { message, content: contentBase64, branch };
    if (existingSha) body.sha = existingSha;

    const resp = await fetch(url, {
      method: 'PUT',
      headers: {
        Authorization: `token ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });

    const result = await resp.json();
    if (!resp.ok) throw new Error(result.message || 'GitHub upload error');
    return result;
  }

  async function saveProject() {
    const title = document.getElementById('title').value;
    const target = document.getElementById('target').value;
    const description = document.getElementById('description').value;
    const collected = document.getElementById('collected').value;
    const file = document.getElementById('imageFile').files[0];

    if (!title || !target || !description) {
      alert('Lengkapi form!');
      return;
    }

    let newProject = {
      id: editId || `p_${Date.now()}`,
      title,
      target,
      description,
      collected,
      image: null,
      createdAt: Date.now()
    };

    const owner = document.getElementById('owner').value;
    const repo = document.getElementById('repo').value;
    const branch = document.getElementById('branch').value;
    const token = document.getElementById('token').value;

    try {
      if (file && token && owner && repo) {
        setStatus('Mengupload gambar ke GitHub...');
        const b64 = await toBase64(file);
        const filename = `image/${Date.now()}_${file.name.replace(/[^a-zA-Z0-9._-]/g, '_')}`;
        await githubPutFile({ owner, repo, path: filename, contentBase64: b64, message: `Upload ${filename}`, branch, token });
        newProject.image = `https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${filename}`;
      }

      if (editId) {
        projects = projects.map(p => p.id === editId ? newProject : p);
      } else {
        projects.unshift(newProject);
      }

      localStorage.setItem('umkm_projects', JSON.stringify(projects));

      if (token && owner && repo) {
        setStatus('Menyimpan projects.json ke GitHub...');
        const content = btoa(JSON.stringify(projects, null, 2));
        await githubPutFile({ owner, repo, path: PROJECTS_PATH, contentBase64: content, message: 'Update projects.json', branch, token });
      }

      setStatus('Project tersimpan.');
      resetForm();
      renderProjects();
    } catch (err) {
      console.error(err);
      setStatus('Error: ' + err.message);
    }
  }

  function renderProjects() {
    const container = document.getElementById('projects');
    container.innerHTML = '';
    if (projects.length === 0) {
      container.innerHTML = '<div class="card">Belum ada project.</div>';
      return;
    }
    projects.forEach(p => {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <div class="flex">
          <div>
            ${p.image ? `<img src="${p.image}" class="project-img">` : '<div class="project-img"></div>'}
          </div>
          <div style="flex:1">
            <h4>${p.title}</h4>
            <p>${p.description}</p>
            <p>Target: ${p.target} | Terkumpul: ${p.collected}</p>
            <div class="flex">
              <button onclick="editProject('${p.id}')">Edit</button>
              <button onclick="deleteProject('${p.id}')">Hapus</button>
            </div>
          </div>
        </div>
      `;
      container.appendChild(div);
    });
  }

  function editProject(id) {
    const p = projects.find(x => x.id === id);
    editId = id;
    document.getElementById('form-title').innerText = 'Edit Project';
    document.getElementById('title').value = p.title;
    document.getElementById('target').value = p.target;
    document.getElementById('description').value = p.description;
    document.getElementById('collected').value = p.collected;
  }

  function deleteProject(id) {
    if (!confirm('Hapus project ini?')) return;
    projects = projects.filter(p => p.id !== id);
    localStorage.setItem('umkm_projects', JSON.stringify(projects));
    renderProjects();
    setStatus('Project dihapus.');
  }

  function resetForm() {
    editId = null;
    document.getElementById('form-title').innerText = 'Tambah Project Donasi';
    document.getElementById('title').value = '';
    document.getElementById('target').value = '';
    document.getElementById('description').value = '';
    document.getElementById('collected').value = 0;
    document.getElementById('imageFile').value = '';
  }

  function setStatus(msg) {
    document.getElementById('statusMsg').innerText = 'Status: ' + msg;
  }
</script>
</body>
</html>
